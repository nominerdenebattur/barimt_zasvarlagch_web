{% extends 'base.html' %}

{% block title %}–ë–∞—Ä–∏–º—Ç –ó–∞—Å–≤–∞—Ä–ª–∞–≥—á{% endblock %}

{% block extra_head %}
<style>
  main {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 24px;
    align-items: start;
  }
  .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,.04);
    }
    .form-section {
      padding: 16px;
      position: sticky;
      top: 16px;
    }
    .form-group { margin-bottom: 14px; }
    .form-group label {
      display: block;
      font-weight: 700;
      margin-bottom: 6px;
    }
.form-group small { color: var(--muted); }
    .form-group input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      outline: none;
    }
    .form-group input:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(42,157,244,.15);
    }
.document-section { padding: 16px; }
    .document-header {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .document-header .left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .doc-title { margin: 0; }
    .date-filter {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .date-filter input[type="date"] {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      outline: none;
    }
    .document-box {
      position: relative;
      width: 100%;
      max-height: 70vh;
      border-radius: 10px;
      border: 1px solid var(--border);
      overflow-x: hidden;
      overflow-y: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-family: Arial, sans-serif;
    }
    thead th {
      position: sticky;
      top: 0;
      background: var(--brand);
      color: #fff;
      text-align: left;
      padding: 10px;
      z-index: 10;
    }
    tbody td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      background: #fff;
    }
    tbody tr:hover { background: #f3f4f6; }
    /* Autocomplete list */

        /* Suggestion list container */
        #suggestions {
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 0;
            margin-top: 2px;
        }

        /* Each suggestion item */
        #suggestions li {
            list-style: none;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            font-size: 14px;
        }

        /* Hover effect */
        #suggestions li:hover {
            background-color: #2a9df4;
            color: #fff;
        }

        /* Optional: highlight selected with keyboard (active class) */
        #suggestions li.active {
            background-color: #0b78d1;
            color: #fff;
        }

        /* Helper chips */

        .helper {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 12px;
            margin-top: 12px;
            background: var(--card);
            border-top: 1px solid var(--border);
            border-radius: 0 0 10px 10px;
        }

        .pagination span {
            font-size: 13px;
            color: var(--muted);
        }
    .submit-section {
        display: flex;
        justify-content: center;
        padding: 20px 12px;

    }
        /* Responsive */
        @media (max-width: 900px) {
            main {
                grid-template-columns: 1fr;
                padding: 20px 16px;
            }

            .form-grid {
                max-height: none;
                position: static;
                grid-template-columns: 1fr;
            }

            .submit-section .btn {
                width: 100%;
            }
        }
</style>
{% endblock %}

{% block content %}
<main>
  <!-- –ë–∞—Ä–∏–º—Ç—ã–Ω –º—ç–¥—ç—ç–ª—ç–ª -->
  <section class="form-section card">
      <div class="form-group">
          <label for="totalAmount">–ù–∏–π—Ç –¥“Ø–Ω</label>
          <input type="text" name="totalAmount" id="totalAmount" placeholder="–ñ: 10000.00">
        </div>

    <div class="form-group">
      <label for="companyReg">–ë–∞–π–≥—É—É–ª–ª–∞–≥—ã–Ω —Ä–µ–≥–∏—Å—Ç–µ—Ä–∏–π–Ω –¥—É–≥–∞–∞—Ä</label>
      <small class="helper">–ë–∞–π–≥—É—É–ª–ª–∞–≥–∞ –±–∏—à –±–æ–ª —Ö–æ–æ—Å–æ–Ω “Ø–ª–¥—ç—ç–Ω—ç “Ø“Ø!</small>
      <input type="text" name="companyReg" id="companyReg" placeholder="–ñ: 1234567">
    </div>

    <div class="form-group">
      <label for="companyFieldTypeInput">–ë–∞—Ä–∏–º—Ç—ã–Ω —Ç”©—Ä”©–ª</label>
      <small class="helper">–ë–∞–π–≥—É—É–ª–ª–∞–≥–∞ –±–æ–ª 3, —Ö—É–≤—å —Ö“Ø–Ω –±–æ–ª 1</small>
      <input type="text" name="companyFieldTypeInput" id="companyFieldTypeInput" value="1" readonly>
    </div>

    <div class="form-group" style="position: relative;">
      <label for="branchName">–°–∞–ª–±–∞—Ä—ã–Ω –Ω—ç—Ä</label>
      <input type="text" id="branchName" autocomplete="off" placeholder="–ñ–∏—à—ç—ç: –¢”©–≤ —à—É—É–¥–∞–Ω" >
      <ul id="suggestions"></ul>
    </div>

    <div class="form-group">
      <label for="storeId">–î—ç–ª–≥“Ø“Ø—Ä–∏–π–Ω –¥—É–≥–∞–∞—Ä</label>
      <input type="text" name="storeId" id="storeId" placeholder="–°–∞–ª–±–∞—Ä —Å–æ–Ω–≥–æ—Ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –±”©–≥–ª”©–≥–¥”©–Ω”©">
    </div>

    <div class="helper">–°–∞–Ω–∞–º–∂: –°–∞–ª–±–∞—Ä—ã–Ω –Ω—ç—Ä –¥—ç—ç—Ä –¥–∞—Ä–≤–∞–ª –¥—ç–ª–≥“Ø“Ø—Ä–∏–π–Ω –¥—É–≥–∞–∞—Ä –±”©–≥–ª”©–≥–¥”©–Ω”©.</div>

    <div class="submit-section">
      <button id="generateBtn" class="btn" type="button">–ë–∞—Ä–∏–º—Ç “Ø“Ø—Å–≥—ç—Ö</button>
    </div>

  </section>

  <!-- –ë–∞—Ä–∏–º—Ç—ã–Ω –∂–∞–≥—Å–∞–∞–ª—Ç -->
  <section class="document-section card" >
    <div class="document-header">
      <div class="left">
        <h3 class="doc-title">–ë–∞—Ä–∏–º—Ç</h3>
        <form method="GET" action="" class="date-filter">
          <label for="selected_date">–û–≥–Ω–æ–æ:</label>
          <input type="date" name="selected_date" id="selected_date" value="{{ selected_date|default:'' }}" >
              <div class="filter-options">
                <label>
                  <input type="checkbox" id="show_deleted"> –£—Å—Ç–≥–∞–≥–¥—Å–∞–Ω
                </label>
{#                <label>#}
{#                  <input type="checkbox" id="show_all"> –ë“Ø–≥–¥#}
{#                </label>#}
              </div>
          <button type="submit" class="btn">–®“Ø“Ø—Ö</button>
        </form>
      </div>
      <div class="right">
        <button id="exportBtn" class="btn" type="button">–ë–∞—Ä–∏–º—Ç —Ç–∞—Ç–∞–∂ –∞–≤–∞—Ö</button>
      </div>
    </div>

    <div class="document-box">
      <table>
        <thead>
          <tr>
            <th scope="col">‚Ññ</th>
            <th scope="col">–î–î–¢–î</th>
            <th scope="col">–ù–∏–π—Ç –¥“Ø–Ω</th>
            <th scope="col">–î—ç–ª–≥“Ø“Ø—Ä</th>
            <th scope="col">–†–µ–≥–∏—Å—Ç–µ—Ä–∏–π–Ω –¥—É–≥–∞–∞—Ä</th>
            <th scope="col">–°—É–≥–∞–ª–∞–∞</th>
            <th scope="col">–û–≥–Ω–æ–æ</th>
            <th scope="col">–ë–∞—Ä–∏–º—Ç —à–∏–≤—Å—ç–Ω —Ö—ç—Ä—ç–≥–ª—ç–≥—á</th>
            <th scope="col">–£—Å—Ç–≥–∞–≥–¥—Å–∞–Ω –±–∞—Ä–∏–º—Ç —ç—Å—ç—Ö</th>
          </tr>
        </thead>
        <tbody>
          {% for barimt in barimtuud %}
            <tr {% if barimt.is_deleted %}style="background-color: #f8d7da;"{% endif %}>
              <td>{{ forloop.counter|add:barimtuud.start_index|add:"-1" }}</td>
              <td>{{ barimt.billId }}</td>
              <td>{{ barimt.totalAmount }}</td>
              <td>{{ barimt.storeNo }}</td>
              <td>{{ barimt.companyReg }}</td>
              <td>{{ barimt.lottery }}</td>
              <td>{{ barimt.created }}</td>
              <td>{{ barimt.created_by.username }}</td>
              <td>{{ barimt.is_deleted|yesno:"–¢–∏–π–º,“Æ–≥“Ø–π" }}</td>
            </tr>
          {% empty %}
            <tr>
                <td colspan="7">–ë–∞—Ä–∏–º—Ç –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
      <div class="pagination">
        {% if barimtuud.has_previous %}
            <a class="btn" href="?page={{ barimtuud.previous_page_number }}&selected_date={{ selected_date }}">”®–º–Ω”©—Ö</a>
        {% endif %}
        <span>–•—É—É–¥–∞—Å {{ barimtuud.number }} / {{ barimtuud.paginator.num_pages }}</span>
        {% if barimtuud.has_next %}
            <a class="btn" href="?page={{ barimtuud.next_page_number }}&selected_date={{ selected_date }}">–î–∞—Ä–∞–∞—Ö</a>
        {% endif %}
      </div>
  </section>
</main>
{% endblock %}

{% block extra_js %}
    <script id="barimtuud-data" type="application/json">
        {{ barimtuud_json|safe }}
    </script>

<script>
    {#// ====== –ë–∞—Ä–∏–º—Ç—ã–Ω –¥–∞—Ç–∞-–≥ JSON-–æ–æ—Å —É–Ω—à–∏—Ö ======#}
    {#const rawData = document.getElementById('barimtuud-data').textContent;#}
    {#let cachedBarimtuud = rawData.trim() ? JSON.parse(rawData) : [];#}

      // –ê–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –±–∞—Ä–∏–º—Ç—ã–Ω —Ç”©—Ä”©–ª —Å–æ–ª–∏—Ö (companyReg –±”©–≥–ª”©–≥–¥–≤”©–ª 3, —Ö–æ–æ—Å–æ–Ω –±–æ–ª 1)
      document.getElementById('companyReg').addEventListener('input', function () {
        const hasReg = this.value.trim().length > 0;
        document.getElementById('companyFieldTypeInput').value = hasReg ? '3' : '1';
      });

      // ====== –°–∞–ª–±–∞—Ä —Ö–∞–π–ª—Ç (autocomplete) ======
      const branchInput = document.getElementById('branchName');
      const suggestionList = document.getElementById('suggestions');
      const storeIdInput = document.getElementById('storeId');

      // Debounce helper
      let debounceTimer = null;
      function debounce(fn, delay) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(fn, delay);
      }

      //auto complete 2-s deesh useg bichij baij salbariin jagshaalt garch irne
      branchInput.addEventListener('input', function () {
        const q = branchInput.value.trim();
        if (q.length < 2) {
          suggestionList.innerHTML = '';
          return;
        }
        debounce(() => {
          fetch('https://pp.cumongol.mn/api/list-biz/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ bizloc_nm: q }) //json format ruu hurvuuleh
          })
            .then(r => r.json())
            .then(data => {
              suggestionList.innerHTML = '';
              const results = (data && data.results) ? data.results : [];
              if (!results.length) return;

              results.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.bizloc_nm}  ‚Äî  ${item.bizloc_cd}`;
                li.dataset.code = item.bizloc_cd;
                li.addEventListener('click', () => {
                  branchInput.value = item.bizloc_nm;
                  storeIdInput.value = item.bizloc_cd;
                  suggestionList.innerHTML = '';
                });
                suggestionList.appendChild(li);
              });
            })
            .catch(err => {
              console.error('API request error:', err);
              suggestionList.innerHTML = '<li style="color:red;">–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞</li>';
            });
        }, 300); //hereglegch bichhe bolisnos 300ms daraa fetch ajillana
      });

      // Click outside to close suggestions
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#suggestions') && e.target !== branchInput) {
          suggestionList.innerHTML = '';
        }
      });

      // ====== –ë–∞—Ä–∏–º—Ç “Ø“Ø—Å–≥—ç—Ö ======
      document.getElementById('generateBtn').addEventListener('click', function () {
        const amount = document.getElementById('totalAmount').value.trim();
        const companyRegNo = document.getElementById('companyReg').value.trim();
        const storeNo = document.getElementById('storeId').value.trim();
        const receiptType = document.getElementById('companyFieldTypeInput').value.trim();
        {#const branchNameVal = branchInput.value.trim();#}

        if (!amount) { alert("–ù–∏–π—Ç –¥“Ø–Ω –æ—Ä—É—É–ª–Ω–∞ —É—É."); return; }
        if (!storeNo) { alert("–î—ç–ª–≥“Ø“Ø—Ä–∏–π–Ω –¥—É–≥–∞–∞—Ä –æ—Ä—É—É–ª–Ω–∞ —É—É."); return; }
        {#if (!branchNameVal) { alert("–°–∞–ª–±–∞—Ä—ã–Ω –Ω—ç—Ä—ç—ç —Å–æ–Ω–≥–æ–Ω–æ —É—É."); return; }#}

        if (!confirm(`–ë–∞—Ä–∏–º—Ç “Ø“Ø—Å–≥—ç—Ö—ç–¥ –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?\n–ù–∏–π—Ç –¥“Ø–Ω: ${amount}\n–ë–∞–π–≥—É—É–ª–ª–∞–≥—ã–Ω —Ä–µ–≥–∏—Å—Ç—Ä: ${companyRegNo || '-'} –î—ç–ª–≥“Ø“Ø—Ä–∏–π–Ω –¥—É–≥–∞–∞—Ä: ${storeNo}\n`)) {
          alert("–¢–∞ –º—ç–¥—ç—ç–ª–ª—ç—ç —à–∞–ª–≥–∞–∞–¥ –¥–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.");
          return;
        }

        const qs = new URLSearchParams({
          totalAmount: amount,
          companyId: companyRegNo,
          storeId: storeNo,
          companyFieldTypeInput: receiptType
        }).toString();

        fetch(`/generate/?${qs}`)
                .then(r => r.json())
                .then(data => {
                    console.log('Response JSON:', data);
                    console.log('data.success:', data.success); // üëà —ç–Ω—ç –Ω—å —è–≥ Boolean true —ç—Å—ç—Ö–∏–π–≥ —Ö–∞—Ä—É—É–ª–Ω–∞
                    if (!data.success) throw new Error(data.message || 'API error');

                    cachedBarimtuud.unshift({
                        billId: data.billId,
                        totalAmount: amount,
                        storeNo: storeNo,
                        companyReg: companyRegNo,
                        lottery: data.lottery,
                        created: data.created,
                        created_by: data.created_by || '-',
                        is_deleted: false
                    });

                    currentPage = 1;
                    updateList();

                    // –¢–∞–ª–±–∞—Ä—É—É–¥—ã–≥ —Ö–æ–æ—Å–ª–æ—Ö
                    document.getElementById('totalAmount').value = '';
                    document.getElementById('companyReg').value = '';
                    document.getElementById('companyFieldTypeInput').value = '1';
                    document.getElementById('storeId').value = '';
                    branchInput.value = '';
                    alert("–ë–∞—Ä–∏–º—Ç –∞–º–∂–∏–ª—Ç—Ç–∞–π —à–∏–≤—ç–≥–¥–ª—ç—ç");
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert("–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.");
                });
      });

      // ====== Excel —Ç–∞—Ç–∞—Ö ======
      document.getElementById('exportBtn').addEventListener('click', function () {
        const amount = document.getElementById('totalAmount').value.trim();
        const companyRegNo = document.getElementById('companyReg').value.trim();
        const storeNo = document.getElementById('storeId').value.trim();

        const qs = new URLSearchParams({
          amount: amount,
          companyReg: companyRegNo,
          storeId: storeNo
        }).toString();

        window.location.href = `/export_excel/?${qs}`;
      });

    // ====== –•—É—É–¥–∞—Å–ª–∞–ª—Ç –±–∞ render ======
    const ITEMS_PER_PAGE = 15;
    let currentPage = 1;
    let filteredList = [];
    const showDeletedCheckbox = document.getElementById('show_deleted');

    function renderBarimt(list, page = 1) {
        const tbody = document.querySelector('.document-box table tbody');
        tbody.innerHTML = '';

        const start = (page - 1) * ITEMS_PER_PAGE;
        const end = start + ITEMS_PER_PAGE;
        const pageItems = list.slice(start, end); // 1‚Äì15, 16‚Äì30, ...

        pageItems.forEach((barimt, idx) => {
            const tr = document.createElement('tr');
            if (barimt.is_deleted) tr.style.backgroundColor = '#f8d7da';
            tr.innerHTML = `
                <td>${start + idx + 1}</td>
                <td>${barimt.billId}</td>
                <td>${barimt.totalAmount}</td>
                <td>${barimt.storeNo}</td>
                <td>${barimt.companyReg || '-'}</td>
                <td>${barimt.lottery || '-'}</td>
                <td>${barimt.created || '-'}</td>
                <td>${barimt.created_by || '-'}</td>
                <td>${barimt.is_deleted ? '–¢–∏–π–º' : '“Æ–≥“Ø–π'}</td>
            `;
            tbody.appendChild(tr);
        });

        // Pagination
        const totalPages = Math.ceil(list.length / ITEMS_PER_PAGE);
        const paginationDiv = document.querySelector('.pagination');
        const paginationSpan = paginationDiv.querySelector('span');
        paginationSpan.textContent = `–•—É—É–¥–∞—Å ${page} / ${totalPages || 1}`;

        // ”®–º–Ω”©—Ö/–î–∞—Ä–∞–∞—Ö —Ç–æ–≤—á–ª—É—É—Ä—É—É–¥
        paginationDiv.querySelectorAll('a').forEach(a => a.remove());

        // ”®–º–Ω”©—Ö —Ç–æ–≤—á
        if (page > 1) {
            const prev = document.createElement('a');
            prev.href = "#";
            prev.className = 'btn';
            prev.textContent = '”®–º–Ω”©—Ö';
            prev.addEventListener('click', e => { e.preventDefault(); currentPage--; updateList(); });
            paginationDiv.insertBefore(prev, paginationSpan);
        }

        if (page < totalPages) {
            const next = document.createElement('a');
            next.href = "#";
            next.className = 'btn';
            next.textContent = '–î–∞—Ä–∞–∞—Ö';
            next.addEventListener('click', e => { e.preventDefault(); currentPage++; updateList(); });
            paginationDiv.appendChild(next);
        }
    }

    function updateList() {
        // 1. Filter: show deleted
        filteredList = [...cachedBarimtuud];
        if (showDeletedCheckbox.checked) filteredList = filteredList.filter(b => b.is_deleted);

        // 2. Filter: selected date
        const selectedDate = document.getElementById('selected_date').value;
        if (selectedDate) filteredList = filteredList.filter(b => b.created.startsWith(selectedDate));

        // 3. Page check
        const totalPages = Math.ceil(filteredList.length / ITEMS_PER_PAGE);
        if (currentPage > totalPages) currentPage = totalPages || 1;

        // 4. Render
        renderBarimt(filteredList, currentPage);
    }

    // Event
    showDeletedCheckbox.addEventListener('change', () => { currentPage = 1; updateList(); });
    document.getElementById('selected_date').addEventListener('change', () => { currentPage = 1; updateList(); });

    // –ê–Ω—Ö —Ö–∞—Ä—É—É–ª–∞—Ö
    updateList();

    </script>
{% endblock %}