{% extends "base.html" %}
{% block title %}Хянах{% endblock %}

{% block extra_head %}
<style>
.card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.toolbar {
    {#display: flex;#}
    gap: 30px;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    margin-bottom: 16px;
}

.date-filter {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
}

h2{
    font-size: 16px
}
h3 {
    color: var(--text);
    margin: 10px 0;
    font-size: 14px
}

table {
    width: 100%;
    border-collapse: collapse;
}
table th, table td {
    padding: 4px 6px; /* padding багасгах */
    font-size: 12px;  /* текстийг жижиг болгох */
}
thead th {
    background: var(--brand);
    color: #fff;
    padding: 10px;
    position: sticky;
    top: 0;
}

tbody td {
    border-bottom: 1px solid var(--border);
    padding: 8px 10px;
}

.document-box {
    width: 100%;
    max-height: 70vh;
    /* дэлгэцийн өндөрт тохируулах */
    overflow-y: auto;
    overflow-x: auto;
    /* vertical scroll гаргах */
    border-radius: 10px;
    border: 1px solid var(--border);
}
.document-box table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    word-wrap: break-word;
}
.pagination {
    position: sticky;
    bottom: 0;
    background: var(--card);
    padding: 10px 0;
    display: flex;
    justify-content: center;
    gap: 10px;
    border-top: 1px solid var(--border);
    z-index: 10;
}
</style>
{% endblock %}

{% block content %}
<div class="card">
  <div class="toolbar">
    <label date-filter for="selected_date">Огноо:</label>
    <input type="date" id="selected_date" value="{{ selected_date }}">
    <button id="fetchBtn" class="btn" type="button">Шүүх</button>
  </div>

  <h2>Шивсэн баримтын жагсаалт</h2>

  <div style="display: flex; gap: 20px; align-items: flex-start;">
 <!-- Хүснэгт 1 -->
  <div style="flex: 1 1 0;">
    <h3>Бүх баримт</h3>
    <div  class="document-box" >
        <table border="1">
            <thead>
                <tr>
                    <th>№</th>
                    <th>storeid</th>
                    <th>receiptno</th>
                    <th>pos_api_lottery</th>
                    <th>pos_api_bill_id</th>
                    <th>pos_api_sub_bill_id</th>
                    <th>grosssale</th>
                    <th>is_return</th>
                </tr>
            </thead>
            <tbody id="barimt-body"></tbody>
        </table>
    </div>
  </div>

    <!-- Хүснэгт 2 -->
    <div style="flex: 1 1 0;">
    <h3>Сугалааны дугааргүй баримт</h3>
    <div class="document-box">
        <table border="1">
            <thead>
                <tr>
                    <th>№</th>
                    <th>storeid</th>
                    <th>receiptno</th>
                    <th>pos_api_lottery</th>
                    <th>pos_api_bill_id</th>
                    <th>pos_api_sub_bill_id</th>
                    <th>grosssale</th>
                    <th>is_return</th>
                </tr>
            </thead>
            <tbody id="lottery-body"></tbody>
        </table>
    </div>
  </div>
  </div>
    </div>
    <div class="pagination" id="pagination">
        {% if has_prev %}
            <a href="?selected_date={{ selected_date }}&page={{ page|add:"-1" }}">Өмнөх</a>
        {% endif %}

        <span>Хуудас {{ page }} / {{ total_pages }}</span>

        {% if has_next %}
            <a href="?selected_date={{ selected_date }}&page={{ page|add:"1" }}">Дараах</a>
        {% endif %}
    </div>



<script>
async function fetchBarimt(date, page = 1) {
    const apiUrl = "https://pp.cumongol.mn/api/bill/";
    const payload = { date, page };

    try {
        const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const data = await response.json();
        const barimtuud = data.items || [];
        const lottery_hooson_barimtuud = barimtuud.filter(b => !b.pos_api_bill_id);

        const barimtBody = document.getElementById("barimt-body");
        barimtBody.innerHTML = "";
        barimtuud.forEach((item, index) => {
            const row = document.createElement("tr");
            if (item.is_return) row.style.backgroundColor = "yellow";
            if (!item.pos_api_bill_id) row.style.backgroundColor = "red";
            row.innerHTML = `
                <td>${index+1}</td>
                <td>${item.storeid || ""}</td>
                <td>${item.receiptno || ""}</td>
                <td>${item.pos_api_lottery || ""}</td>
                <td>${item.pos_api_bill_id || ""}</td>
                <td>${item.pos_api_sub_bill_id || ""}</td>
                <td>${item.grosssale || ""}</td>
                <td>${item.is_return}</td>
            `;
            barimtBody.appendChild(row);
        });

        const lotteryBody = document.getElementById("lottery-body");
        lotteryBody.innerHTML = "";
        lottery_hooson_barimtuud.forEach((item, index) => {
            const row = document.createElement("tr");
            row.style.backgroundColor = "red";
            row.style.color = "white";
            row.innerHTML = `
                <td>${index+1}</td>
                <td>${item.storeid || ""}</td>
                <td>${item.receiptno || ""}</td>
                <td>${item.pos_api_lottery || ""}</td>
                <td>${item.pos_api_bill_id || ""}</td>
                <td>${item.pos_api_sub_bill_id || ""}</td>
                <td>${item.grosssale || ""}</td>
                <td>${item.is_return}</td>
            `;
            lotteryBody.appendChild(row);
        });

        // Pagination
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";
        if (data.has_prev) {
            const prev = document.createElement("button");
            prev.textContent = "Өмнөх";
            prev.onclick = () => fetchBarimt(date, page-1);
            pagination.appendChild(prev);
        }
        const span = document.createElement("span");
        span.textContent = ` ${page} / ${data.total_pages} `;
        pagination.appendChild(span);
        if (data.has_next) {
            const next = document.createElement("button");
            next.textContent = "Дараах";
            next.onclick = () => fetchBarimt(date, page+1);
            pagination.appendChild(next);
        }

    } catch (err) {
        console.error("API Error:", err);
    }
}

// Event
document.addEventListener("DOMContentLoaded", () => {
    const selectedDate = document.getElementById("selected_date").value;
    if(selectedDate) fetchBarimt(selectedDate, 1);

    document.getElementById("fetchBtn").addEventListener("click", () => {
        const date = document.getElementById("selected_date").value;
        fetchBarimt(date, 1);
    });
});
</script>
{% endblock %}
